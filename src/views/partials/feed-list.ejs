<% if (feedItems && feedItems.length > 0) { %>
    <% feedItems.forEach(item => { %>
        <div class="timeline-item">
            <div class="timeline-left">
                <div class="user-avatar-small" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <%= item.username.charAt(0).toUpperCase() %>
                </div>
                <div class="timeline-line"></div>
            </div>
            
            <div class="timeline-card">
                <div class="card-header">
                    <span class="username">@<%= item.username %></span>
                    <span class="meta-date"><%= new Date(item.created_at).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) %></span>
                </div>
                
                <div class="card-body">
                    <% if (item.action_type === 'added_book') { %>
                        <div class="action-icon added">üìö</div>
                        <div class="action-text">
                            Added <a href="/search?q=<%= item.book_title %>" class="book-link"><%= item.book_title %></a> to their library.
                        </div>
                    <% } else if (item.action_type === 'created_note') { %>
                        <div class="action-icon note">‚úçÔ∏è</div>
                        <div class="action-text">
                            Wrote a new note on <a href="/search?q=<%= item.book_title %>" class="book-link"><%= item.book_title %></a>.
                        </div>
                    <% } else if (item.action_type === 'shared_note') { %>
                        <div class="action-icon shared">üîó</div>
                        <div class="action-text">
                            Shared a <a href="/share/<%= item.share_slug %>" class="share-link-text">thought</a> on <a href="/search?q=<%= item.book_title %>" class="book-link"><%= item.book_title %></a>.
                        </div>
                    <% } %>
                </div>
                <div class="card-footer">
                    <div class="reactions-bar" data-activity-id="<%= item.activity_id %>">
                        <% 
                        const reactionTypes = [
                            { type: 'heart', emoji: '‚ù§Ô∏è' },
                            { type: 'like', emoji: 'üëç' },
                            { type: 'fire', emoji: 'üî•' },
                            { type: 'mind_blown', emoji: 'ü§Ø' }
                        ];
                        %>
                        <% reactionTypes.forEach(r => { 
                            const myReaction = item.my_reactions && item.my_reactions.includes(r.type);
                            const countObj = item.reactions && item.reactions.find(rx => rx.type === r.type);
                            const count = countObj ? countObj.count : 0;
                        %>
                            <button class="reaction-btn <%= myReaction ? 'active' : '' %>" data-type="<%= r.type %>" aria-label="React with <%= r.type %>">
                                <span class="emoji"><%= r.emoji %></span>
                                <span class="count"><%= count > 0 ? count : '' %></span>
                            </button>
                        <% }) %>
                    </div>
                </div>
            </div>
        </div>
    <% }) %>
<% } %>
